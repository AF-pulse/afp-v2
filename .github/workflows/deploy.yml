name: Build & Deploy AFP Jobs

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

env:
  ACR_NAME: ${{ secrets.ACR_NAME }}                  # t.ex. myregistry (utan .azurecr.io)
  ACR_LOGIN_SERVER: ${{ secrets.ACR_NAME }}.azurecr.io
  IMAGE_NAME: afp-runner
  IMAGE_TAG: v${{ github.run_number }}-${{ github.sha }}
  # Full image referens som vi sätter på alla tre jobben:
  IMAGE_REF: ${{ secrets.ACR_NAME }}.azurecr.io/afp-runner:v${{ github.run_number }}-${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}   # JSON från az ad sp create-for-rbac

      - name: ACR login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}     # service principal / admin user
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build & push image
        run: |
          docker build -t $IMAGE_REF .
          docker push $IMAGE_REF

      # Uppdatera ACA-jobs med ny image + env/secrets
      - name: Update collect job (JOB_TYPE=collect)
        run: |
          az containerapp job update \
            --name afp-collect-job \
            --resource-group ${{ secrets.AZ_RESOURCE_GROUP }} \
            --image $IMAGE_REF \
            --set-env-vars JOB_TYPE=collect BLOB_PREFIX=collector/ \
            --set-secrets "BLOB_CONTAINER_SAS_URL=${{ secrets.AZ_SAS_SECRET_NAME }}"

      - name: Update produce job (JOB_TYPE=produce)
        run: |
          az containerapp job update \
            --name afp-produce-job \
            --resource-group ${{ secrets.AZ_RESOURCE_GROUP }} \
            --image $IMAGE_REF \
            --set-env-vars JOB_TYPE=produce BLOB_PREFIX=producer/ \
            --set-secrets "BLOB_CONTAINER_SAS_URL=${{ secrets.AZ_SAS_SECRET_NAME }}"

      - name: Update assemble job (JOB_TYPE=assemble)
        run: |
          az containerapp job update \
            --name afp-assemble-job \
            --resource-group ${{ secrets.AZ_RESOURCE_GROUP }} \
            --image $IMAGE_REF \
            --set-env-vars JOB_TYPE=assemble BLOB_PREFIX=assembler/ \
            --set-secrets "BLOB_CONTAINER_SAS_URL=${{ secrets.AZ_SAS_SECRET_NAME }}"
